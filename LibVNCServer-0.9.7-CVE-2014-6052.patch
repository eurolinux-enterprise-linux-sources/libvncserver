From 8d45ec80de49d14cfd6caf4462388fd90a334aad Mon Sep 17 00:00:00 2001
From: newsoft <newsoft@MacBook-Air-de-newsoft-2.local>
Date: Fri, 31 Oct 2014 12:46:28 +0100
Subject: [PATCH] Check for MallocFrameBuffer() return value
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

If MallocFrameBuffer() returns FALSE, frame buffer pointer is left to
NULL. Subsequent writes into that buffer could lead to memory
corruption, or even arbitrary code execution.

Petr Pisar: Ported to 0.9.7.

Signed-off-by: Petr Písař <ppisar@redhat.com>
---
 libvncclient/rfbproto.c  | 10 +++++++---
 libvncclient/vncviewer.c |  3 ++-
 2 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/libvncclient/rfbproto.c b/libvncclient/rfbproto.c
index 85aa98d..88f8ba7 100644
--- a/libvncclient/rfbproto.c
+++ b/libvncclient/rfbproto.c
@@ -1163,7 +1163,8 @@ HandleRFBServerMessage(rfbClient* client)
       if (rect.encoding == rfbEncodingNewFBSize) {
 	client->width = rect.r.w;
 	client->height = rect.r.h;
-	client->MallocFrameBuffer(client);
+	if (!client->MallocFrameBuffer(client))
+	  return FALSE;
 	SendFramebufferUpdateRequest(client, 0, 0, rect.r.w, rect.r.h, FALSE);
 	rfbClientLog("Got new framebuffer size: %dx%d\n", rect.r.w, rect.r.h);
 	continue;
@@ -1592,7 +1593,8 @@ HandleRFBServerMessage(rfbClient* client)
       return FALSE;
     client->width = rfbClientSwap16IfLE(msg.rsfb.framebufferWidth);
     client->height = rfbClientSwap16IfLE(msg.rsfb.framebufferHeigth);
-    client->MallocFrameBuffer(client);
+    if (!client->MallocFrameBuffer(client))
+      return FALSE;
     SendFramebufferUpdateRequest(client, 0, 0, client->width, client->height, FALSE);
     rfbClientLog("Got new framebuffer size: %dx%d\n", client->width, client->height);
     break;
@@ -1605,7 +1607,9 @@ HandleRFBServerMessage(rfbClient* client)
       return FALSE;
     client->width = rfbClientSwap16IfLE(msg.prsfb.buffer_w);
     client->height = rfbClientSwap16IfLE(msg.prsfb.buffer_h);
-    client->MallocFrameBuffer(client);
+    if (!client->MallocFrameBuffer(client))
+      return FALSE;
+
     SendFramebufferUpdateRequest(client, 0, 0, client->width, client->height, FALSE);
     rfbClientLog("Got new framebuffer size: %dx%d\n", client->width, client->height);
     break;
diff --git a/libvncclient/vncviewer.c b/libvncclient/vncviewer.c
index 9d5107e..c5b2abc 100644
--- a/libvncclient/vncviewer.c
+++ b/libvncclient/vncviewer.c
@@ -221,7 +221,8 @@ static rfbBool rfbInitConnection(rfbClient* client)
 
   client->width=client->si.framebufferWidth;
   client->height=client->si.framebufferHeight;
-  client->MallocFrameBuffer(client);
+  if (!client->MallocFrameBuffer(client))
+    return FALSE;
 
   if (client->updateRect.x < 0) {
     client->updateRect.x = client->updateRect.y = 0;
-- 
1.9.3

